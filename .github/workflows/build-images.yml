name: Build OCI Images

on:
  pull_request:
    paths:
      - 'packer/**'
      - 'terraform/**'
      - 'Makefile'
      - 'lib.sh'
      - '.github/workflows/build-images.yml'
  workflow_dispatch:
    inputs:
      build_target:
        description: 'Image to build (all, image-builder, base-images, cache-images, win-images)'
        required: false
        default: 'win-images'
        type: choice
        options:
          - all
          - image-builder
          - base-images
          - cache-images
          - win-images
      debug_mode:
        description: 'Debug mode - keeps instance running for 2h for troubleshooting'
        required: false
        default: false
        type: boolean

env:
  OCI_REGION: us-ashburn-1
  PACKER_VERSION: '1.10.0'

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Validate shell scripts
        run: |
          shellcheck lib.sh || true
          find packer -name "*.sh" -exec shellcheck {} \; || true

      - name: Packer init
        run: |
          for dir in packer/*/; do
            if ls "${dir}"*.pkr.hcl &>/dev/null; then
              echo "Initializing ${dir}..."
              packer init "${dir}"
            fi
          done

      - name: Packer validate
        run: |
          for dir in packer/*/; do
            if ls "${dir}"*.pkr.hcl &>/dev/null; then
              echo "Validating ${dir}..."
              # Add winrm_password for Windows builds
              EXTRA_VARS=""
              if [[ "$dir" == *"win-images"* ]]; then
                EXTRA_VARS="-var winrm_password=DummyP@ss123"
              fi
              packer validate \
                -var "compartment_ocid=ocid1.compartment.oc1..dummy" \
                -var "subnet_ocid=ocid1.subnet.oc1..dummy" \
                -var "availability_domain=AD-1" \
                -var "base_image_ocid=ocid1.image.oc1..dummy" \
                $EXTRA_VARS \
                "${dir}" || true
            fi
          done

  # TODO: Uncomment Linux builds once Windows is working
  # image-builder:
  #   name: Build Image Builder
  #   needs: validate
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 50
  #   if: |
  #     github.event_name == 'workflow_dispatch' &&
  #     (github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'image-builder')
  #     || github.event_name == 'pull_request'
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Setup Packer
  #       uses: hashicorp/setup-packer@main
  #       with:
  #         version: ${{ env.PACKER_VERSION }}
  #     - name: Configure OCI credentials
  #       run: |
  #         mkdir -p ~/.oci
  #         echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
  #         chmod 600 ~/.oci/oci_api_key.pem
  #         cat > ~/.oci/config << EOF
  #         [DEFAULT]
  #         user=${{ secrets.OCI_USER_OCID }}
  #         fingerprint=${{ secrets.OCI_FINGERPRINT }}
  #         tenancy=${{ secrets.OCI_TENANCY_OCID }}
  #         region=${{ env.OCI_REGION }}
  #         key_file=~/.oci/oci_api_key.pem
  #         EOF
  #         sed -i 's/^[[:space:]]*//' ~/.oci/config
  #     - name: Generate IMG_SFX
  #       run: make IMG_SFX
  #     - name: Build image-builder
  #       run: |
  #         packer init packer/image-builder/
  #         packer build \
  #           -var "compartment_ocid=${{ secrets.OCI_COMPARTMENT_OCID }}" \
  #           -var "subnet_ocid=${{ secrets.OCI_SUBNET_OCID }}" \
  #           -var "availability_domain=${{ secrets.OCI_AVAILABILITY_DOMAIN }}" \
  #           -var "base_image_ocid=${{ secrets.OCI_BASE_IMAGE_OCID }}" \
  #           -var "img_sfx=$(cat IMG_SFX)" \
  #           packer/image-builder/
  #     - name: Upload manifest
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: image-builder-manifest
  #         path: packer/image-builder/manifest.json

  # base-images:
  #   name: Build Fedora Base Images
  #   needs: [validate, image-builder]
  #   ... (commented out for now)

  # cache-images:
  #   name: Build Fedora Cache Images
  #   needs: [validate, image-builder, base-images]
  #   ... (commented out for now)

  win-images:
    name: Build Windows Server Images
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Windows builds take longer
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'win-images')
      || github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Configure OCI credentials
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ env.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          sed -i 's/^[[:space:]]*//' ~/.oci/config

      - name: Generate IMG_SFX
        run: make IMG_SFX

      - name: Generate WinRM password
        id: winrm
        run: |
          # Generate a secure random password for WinRM
          WINRM_PASSWORD=$(openssl rand -base64 24 | tr -dc 'a-zA-Z0-9!@#$%' | head -c 20)
          # Ensure it meets Windows complexity requirements
          WINRM_PASSWORD="${WINRM_PASSWORD}Aa1!"
          echo "::add-mask::${WINRM_PASSWORD}"
          echo "password=${WINRM_PASSWORD}" >> $GITHUB_OUTPUT

      - name: Install OCI CLI
        run: |
          pip install oci-cli
          oci setup repair-file-permissions --file ~/.oci/config
          oci setup repair-file-permissions --file ~/.oci/oci_api_key.pem

      - name: Build Windows images
        id: packer_build
        run: |
          packer init packer/win-images/

          # Set debug mode from input
          DEBUG_MODE="${{ inputs.debug_mode || 'false' }}"
          echo "Debug mode: $DEBUG_MODE"

          # Run Packer with debug output
          PACKER_LOG=1 packer build \
            -var "compartment_ocid=${{ secrets.OCI_COMPARTMENT_OCID }}" \
            -var "subnet_ocid=${{ secrets.OCI_SUBNET_OCID }}" \
            -var "availability_domain=${{ secrets.OCI_AVAILABILITY_DOMAIN }}" \
            -var "base_image_ocid=${{ secrets.OCI_WINDOWS_BASE_OCID }}" \
            -var "winrm_password=${{ steps.winrm.outputs.password }}" \
            -var "debug_mode=$DEBUG_MODE" \
            -var "img_sfx=$(cat IMG_SFX)" \
            packer/win-images/ 2>&1 | tee packer.log || true

          # Extract instance OCID and IP from log
          INSTANCE_OCID=$(grep -oP 'ocid1\.instance\.[^)"\s]+' packer.log | head -1 || echo "")
          INSTANCE_IP=$(grep -oP '\d+\.\d+\.\d+\.\d+' packer.log | head -1 || echo "")
          echo "instance_ocid=${INSTANCE_OCID}" >> $GITHUB_OUTPUT
          echo "instance_ip=${INSTANCE_IP}" >> $GITHUB_OUTPUT

      - name: Debug - Get instance connection info
        if: always() && steps.packer_build.outputs.instance_ocid != ''
        run: |
          echo "=========================================="
          echo "INSTANCE DEBUG INFO"
          echo "=========================================="
          echo "Instance OCID: ${{ steps.packer_build.outputs.instance_ocid }}"
          echo "Instance IP: ${{ steps.packer_build.outputs.instance_ip }}"
          echo ""

          # Get instance state
          INSTANCE_STATE=$(oci compute instance get \
            --instance-id "${{ steps.packer_build.outputs.instance_ocid }}" \
            --query 'data."lifecycle-state"' --raw-output 2>/dev/null || echo "UNKNOWN")
          echo "Instance State: $INSTANCE_STATE"

          # Get public IP if available
          echo ""
          echo "Looking for VNIC attachments..."
          oci compute instance list-vnics \
            --instance-id "${{ steps.packer_build.outputs.instance_ocid }}" \
            --query 'data[0].{"public-ip":"public-ip", "private-ip":"private-ip"}' 2>/dev/null || echo "Could not get VNIC info"

          echo ""
          echo "WinRM Password (for opc user): Check masked output above"
          echo ""

          # Only try to get initial creds if instance is still running
          if [ "$INSTANCE_STATE" = "RUNNING" ]; then
            echo "OCI-generated credentials (if available):"
            oci compute instance get-windows-initial-creds \
              --instance-id "${{ steps.packer_build.outputs.instance_ocid }}" 2>/dev/null || echo "Could not get OCI credentials"
          fi

          echo ""
          echo "=========================================="
          if [ "${{ inputs.debug_mode }}" = "true" ] && [ "$INSTANCE_STATE" = "RUNNING" ]; then
            echo "DEBUG MODE: Instance will stay running for ~2 hours"
            echo "Connect via RDP to the public IP above"
            echo "Username: opc"
            echo "Password: (the generated WinRM password)"
          fi
          echo "=========================================="

      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: win-images-manifest
          path: packer/win-images/manifest.json

  success:
    name: Build Complete
    needs: [validate, win-images]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Validate: ${{ needs.validate.result }}"
          echo "Win-images: ${{ needs.win-images.result }}"
          if [ "${{ needs.validate.result }}" != "success" ]; then
            echo "Validation failed"
            exit 1
          fi
          echo "All requested builds completed"
